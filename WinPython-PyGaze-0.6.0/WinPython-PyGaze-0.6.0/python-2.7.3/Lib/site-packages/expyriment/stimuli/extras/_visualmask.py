#!/usr/bin/env python

"""
A Visual Mask.

This module contains a class implementing a Visual Mask.

"""

__author__ = 'Florian Krause <siebenhundertzehn@gmail.com>, \
Oliver Lindemann <lindemann09@gmail.com>'
__version__ = '0.6.2'
__revision__ = '23032f47ffea'
__date__ = 'Wed Dec 12 15:49:59 2012 +0100'


from random import shuffle
import tempfile
import os

try:
    from PIL import Image, ImageDraw, ImageFilter #import PIL
except:
    Image = None

import expyriment
from expyriment.misc import Clock
from expyriment.stimuli._picture import Picture
import defaults


class VisualMask(Picture):
    """A class implementing a visual mask stimulus."""

    def __init__(self, size, position=None, dot_size=None,
                 background_colour=None, dot_colour=None,
                 dot_percentage=None, smoothing=None):
        """Create a visual mask.

        Keyword arguments:
        size              -- the size (x, y) of the mask (int, int)
        position          -- the position of the mask stimulus (int,int)
        dot_size          -- the size (x, y) of the dots (int,int, optional)
        background_colour -- the background colour (int,int,int) (optional)
        dot_colour        -- the dot colour (int,int,int) (optional)
        dot_percentage    -- the percentage of covered area by the dots
                                 (int, 1 to 100) (optional)
        smoothing         -- the smoothing (int, optional, default=3)

        """

        import types
        if type(Image) is not types.ModuleType:
            message = """VisualMask can not be initialized.
The Python package 'Python Imaging Library (PIL)' is not installed."""
            raise ImportError(message)

        fid, filename = tempfile.mkstemp(
                    dir=expyriment.stimuli.defaults.tempdir,
                    suffix=".png")
        os.close(fid)
        Picture.__init__(self, filename, position)

        self._size = size
        if dot_size is not None:
            self.dot_size = dot_size
        else:
            self.dot_size = defaults.visualmask_dot_size
        if background_colour is None:
            self.background_colour = defaults.visualmask_background_colour
        if background_colour is not None:
            self.background_colour = background_colour
        else:
            self.background_colour = expyriment._active_exp.background_colour
        if dot_colour is None:
            self.dot_colour = defaults.visualmask_dot_colour
        if dot_colour is not None:
            self.dot_colour = dot_colour
        else:
            self.dot_colour = expyriment._active_exp.foreground_colour
        if dot_percentage is not None:
            self.dot_percentage = dot_percentage
        else:
            self.dot_percentage = defaults.visualmask_dot_percentage
        if smoothing is not None:
            self.smoothing = smoothing
        else:
            self.smoothing = defaults.visualmask_smoothing

        self.create_mask()

    def create_mask(self):
        """Creates a new visual mask.

        CAUTION: Depending on the size of the stimulus, this method may take
        some time to execute.

        Returns the time it took to execute this method.

        """

        start = Clock._cpu_time()
        was_preloaded = self.is_preloaded
        if was_preloaded:
            self.unload()

        s = (self._size[0] + 4 * self.smoothing,
             self._size[1] + 4 * self.smoothing) #somewhat larger mask 
        im = Image.new("RGB", s)
        draw = ImageDraw.Draw(im)
        draw.rectangle([(0, 0), s], outline=self.background_colour,
                       fill=self.background_colour)

        n_dots_x = int(s[0] / self.dot_size[0]) + 1
        n_dots_y = int(s[1] / self.dot_size[1]) + 1
        dots = range(n_dots_x * n_dots_y)
        shuffle(dots)
        for d in dots[:int(len(dots) * self.dot_percentage / 100)]:
            y = (d / n_dots_x) * self.dot_size[1]
            x = (d % n_dots_x) * self.dot_size[0]
            draw.rectangle([(x, y),
                            (x + self.dot_size[0], y + self.dot_size[1])],
                           outline=self.dot_colour, fill=self.dot_colour)

        for x in range(self.smoothing):
            im = im.filter(ImageFilter.BLUR).filter(ImageFilter.SMOOTH_MORE)

        #crop image and save
        c = (im.size[0] / 2, im.size[1] / 2)
        box = (c[0] - self._size[0] / 2, c[1] - self._size[1] / 2,
               c[0] + self._size[0] / 2, c[1] + self._size[1] / 2)
        im = im.crop(box)
        im.save(self._filename, format="png")

        if was_preloaded:
            self.preload()
        return int((Clock._cpu_time() - start) * 1000)


if __name__ == "__main__":
    from expyriment import control
    control.set_develop_mode(True)
    defaults.event_logging = 0
    exp = control.initialize()
    mask = VisualMask(size=(200, 200))
    mask.present()
    print mask.surface_size
    exp.clock.wait(1000)
